# This file is for LOCAL DEVELOPMENT only.
# It overrides settings in docker-compose.yml

services:
  backend:
    # Override the command to enable --reload for uvicorn
    command: uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000 --reload-dir /app/phase --reload-dir /app/backend
    volumes:
      # Volumes are already defined in the base file,
      # but we re-state them here for clarity.
      - ./phase:/app/phase
      - ./backend:/app/backend
      - /scratch/docker/phase-data:/data/phase

  frontend:
    # Use the dev-specific Dockerfile
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      # Mount the source code
      - ./frontend:/app           # Sync everything
      - /app/node_modules         # Anonymous volume: Keep container's node_modules
    environment:
      # This is required for create-react-app
      # to detect file changes inside Docker
      - CHOKIDAR_USEPOLLING=true
      - HOST=0.0.0.0
      - DANGEROUSLY_DISABLE_HOST_CHECK=true
      - WDS_SOCKET_PORT=0
  
  # Add an override for the 'worker' service for live-reloading
  worker:
    # This command uses 'watchmedo' (from the 'watchdog' package)
    # to monitor the /app/phase directory for .py file changes
    # and automatically restart the 'rq worker' command.
    command: >
      watchmedo auto-restart
        --directory=/app/phase
        --pattern="*.py"
        --recursive
        --
        rq worker phase-jobs --url redis://redis:6379/0
    # The volumes are inherited from docker-compose.yml,
    # so the local files are already mounted.
